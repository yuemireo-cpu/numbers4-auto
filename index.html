<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆ</title>
  <style>
    body{font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;padding:16px;max-width:860px;margin:auto}
    h1{font-size:34px;margin:10px 0 18px}
    input,textarea,button,select{font-size:16px;padding:12px;width:100%;box-sizing:border-box;margin:8px 0;border-radius:14px;border:1px solid #e5e5e5}
    textarea{min-height:90px;resize:vertical}
    button{background:#111;color:#fff;border:none;border-radius:999px;padding:16px;font-weight:800}
    .box{background:#fafafa;border:1px solid #eee;border-radius:16px;padding:14px;margin-top:12px}
    .label{font-weight:800;margin-top:6px}
    pre{white-space:pre-wrap;background:#f7f7f7;border-radius:14px;padding:12px;border:1px solid #eee}
    .day{font-weight:900;margin:8px 0 0}
    .note{color:#666;font-size:12px;margin-top:6px;line-height:1.5}
  </style>
</head>
<body>

  <h1>ãƒŠãƒ³ãƒãƒ¼ã‚º4 å®Œæˆç‰ˆ</h1>

  <div class="box">
    <div class="label">ãƒ’ãƒ³ãƒˆ1ï¼ˆä¾‹ï¼š168 / 1ãƒ»6ãƒ»8ï¼‰</div>
    <input id="hint1" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ1 ä¾‹ï¼š168">

    <div class="label">ãƒ’ãƒ³ãƒˆ2ï¼ˆä¾‹ï¼š3920 / 3ãƒ»9ãƒ»2ãƒ»0ï¼‰</div>
    <input id="hint2" inputmode="numeric" placeholder="ãƒ’ãƒ³ãƒˆ2 ä¾‹ï¼š3920">

    <div class="label">å‰å›ï¼ˆä»»æ„ï¼‰</div>
    <input id="prev" inputmode="numeric" placeholder="å‰å› ä¾‹ï¼š5105" maxlength="4">

    <div class="label">å‰ã€…å›ï¼ˆä»»æ„ï¼‰</div>
    <input id="prev2" inputmode="numeric" placeholder="å‰ã€…å› ä¾‹ï¼š4588" maxlength="4">

    <div class="label">ç›´è¿‘10å›ï¼ˆä»»æ„ãƒ»4æ¡Ã—10ã‚’è²¼ã‚‹ï¼‰</div>
    <textarea id="recent" placeholder="ä¾‹ï¼š
4141â†’2121â†’7202â†’7526â†’2300â†’7263â†’1632â†’6551â†’2827â†’2699"></textarea>

    <div class="note">
      â€»åŒã˜å…¥åŠ›ãªã‚‰ä½•å›æŠ¼ã—ã¦ã‚‚åŒã˜çµæœï¼ˆãƒ–ãƒ¬ãªã„ï¼‰<br>
      â€»18æ™‚ã‚®ãƒªã‚®ãƒªã®ãƒªãƒãƒ¼ã‚µãƒ«æ•°å­—ã¯å…¥åŠ›ã—ãªã„ï¼ˆã‚†ã†ã¡ã‚ƒã‚“æ–¹é‡ï¼‰
    </div>

    <button onclick="generate()">ç•ªå·ã‚’ç”Ÿæˆã™ã‚‹</button>
  </div>

  <h2 style="margin-top:22px;">ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>
  <div id="dayPower" class="day"></div>
  

  <h2 style="margin-top:22px;">ã‚»ãƒƒãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>
  <h2>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>
<div id="dayPower" style="font-weight:bold;margin:8px 0;"></div>

<h3>æœ¬å‘½ï¼ˆå¼·ï¼‰</h3>
<pre id="straightMain"></pre>

<h3>ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</h3>
<pre id="straightIns"></pre>

<h2>ã‚»ãƒƒãƒˆï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>

<h3>æœ¬å‘½ï¼ˆå¼·ï¼‰</h3>
<pre id="setMain"></pre>

<h3>ä¿é™ºï¼ˆä¸­ãƒ»å¼±ï¼‰</h3>
<pre id="setIns"></pre>

<script>
  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  const ura = {0:5,5:0,1:6,6:1,2:7,7:2,3:8,8:3,4:9,9:4};

  function d(str){ return (str || "").match(/\d/g) || []; }

  function uniq(arr){
    const s = new Set(), out=[];
    for(const x of arr){ if(!s.has(x)){ s.add(x); out.push(x); } }
    return out;
  }

  // æ–‡å­—åˆ—â†’å®‰å®šã‚·ãƒ¼ãƒ‰ï¼ˆåŒã˜å…¥åŠ›ãªã‚‰åŒã˜ä¹±æ•°åˆ—ï¼‰
  function hash32(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  function mulberry32(seed){
    return function(){
      let t = seed += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  function pick(pool, rand){
    return pool[Math.floor(rand() * pool.length)];
  }

  // ===== ã‚¹ã‚³ã‚¢ï¼ˆææ–™ã®é‡ã¿ï¼‰=====
  function scoreDigits(){
    const s = Array(10).fill(0);

    // ç›´è¿‘10å›ï¼šå‡ºç¾ã—ãŸæ¡ã‚’+1
    d(document.getElementById("recent").value).forEach(x => s[+x] += 1);

    // å‰å›+3 / å‰ã€…å›+2ï¼ˆã‚†ã†ã¡ã‚ƒã‚“ã®ã€Œå¼•ã£å¼µã‚Šã€å¯„ã›ï¼‰
    d(document.getElementById("prev").value).forEach(x => s[+x] += 3);
    d(document.getElementById("prev2").value).forEach(x => s[+x] += 2);

    return s;
  }

  // è»¸2æ¡ï¼šãƒ’ãƒ³ãƒˆå…±é€šå„ªå…ˆâ†’ãªã‘ã‚Œã°ã‚¹ã‚³ã‚¢ä¸Šä½
  function chooseAxis(h1, h2, s){
    const common = h1.filter(x => h2.includes(x));
    if(common.length >= 2) return common.slice(0,2);
    if(common.length === 1){
      const rest = [...h1, ...h2].filter(x => x !== common[0]);
      const b = rest.sort((a,b)=> s[+b] - s[+a])[0] || common[0];
      return [common[0], b];
    }
    const all = [...h1, ...h2];
    if(all.length >= 2) return all.sort((a,b)=> s[+b] - s[+a]).slice(0,2);
    // ä½•ã‚‚ãªã„æ™‚ã®ä¿é™º
    return ["4","8"];
  }

  // ãƒ—ãƒ¼ãƒ«ï¼šãƒ’ãƒ³ãƒˆï¼‹è£æ•°å­—ï¼‹Â±1ï¼‹ã‚¹ã‚³ã‚¢ã§é‡ã¿
  function buildPool(h1, h2, s){
    let p = [...h1, ...h2];

    // è£æ•°å­—
    Object.keys(ura).forEach(k => p.push(String(ura[k])));

    // é€£ç•ªï¼ˆÂ±1ï¼‰
    p.forEach(x => {
      const n = +x;
      if(n > 0) p.push(String(n-1));
      if(n < 9) p.push(String(n+1));
    });

    // ã‚¹ã‚³ã‚¢åˆ†ã ã‘æ•°å­—ã‚’è¿½åŠ ï¼ˆé‡ã¿ä»˜ã‘ï¼‰
    for(let digit=0; digit<=9; digit++){
      for(let i=0; i<s[digit]; i++) p.push(String(digit));
    }

    return uniq(p);
  }

  // ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆè©•ä¾¡è»¸ï¼‰=====
  // ã€Œè¶³ã™9ã€ã€Œé€£ç•ªã€è¦ç´ ã§ã‚¹ã‚³ã‚¢ã€‚â€»ã“ã“ã¯å¥½ã¿ã§é‡ã¿å¤‰æ›´OK
  function rank(nums){
    return nums.map(n=>{
      let sc=0;
      const a = n.split("").map(Number);

      for(let i=0;i<4;i++) for(let j=i+1;j<4;j++){
        if(a[i]+a[j]===9) sc += 3;                 // è¶³ã™9
        if(Math.abs(a[i]-a[j])===1) sc += 2;      // é€£ç•ª
      }
      return { n, sc };
    }).sort((A,B)=>B.sc - A.sc);
  }

  // å¼·ã•ãƒ©ãƒ™ãƒ«ï¼ˆbestæ¯”ï¼‰
  function tierLabel(score, best){
    if(best <= 0) return { badge:"â˜…", label:"å¼±" };
    const r = score / best;
    if(r >= 0.92) return { badge:"â˜…â˜…â˜…", label:"å¼·" };
    if(r >= 0.86) return { badge:"â˜…â˜…",  label:"ä¸­" };
    return { badge:"â˜…",   label:"å¼±" };
  }
function splitRanked(ranked, limit = 10){
  if(!ranked || ranked.length === 0) return { main: [], ins: [] };

  const best = ranked[0].sc;
  const rows = ranked.slice(0, limit).map((r, i) => {
    const t = tierLabel(r.sc, best);
    return {
      i: i + 1,
      num: r.n || r.num,
      badge: t.badge,
      label: t.label
    };
  });

  return {
    main: rows.filter(x => x.label === "å¼·"),
    ins : rows.filter(x => x.label !== "å¼·")
  };
}

function formatRows(rows){
  if(!rows || rows.length === 0) return "ï¼ˆãªã—ï¼‰";
  return rows.map(x =>
    `${x.i}ä½  ${x.badge} [${x.label}]  ${x.num}`
  ).join("\n");
}
  // ã€Œä»Šæ—¥ã¯å¼·ã„æ—¥ã€åˆ¤å®šï¼ˆè¡¨ç¤ºã•ã‚ŒãŸå£æ•°ã§åˆ¤å®šï¼‰
  function judgeDayPower(count){
    if(count <= 5) return "ğŸ”¥ ä»Šæ—¥ã¯å¼·ã„æ—¥ï¼ˆé›†ä¸­å‹è² ï¼‰";
    if(count <= 8) return "â— æ™®é€šã®æ—¥ï¼ˆãƒãƒ©ãƒ³ã‚¹ï¼‰";
    return "â–³ åˆ†æ•£ã®æ—¥ï¼ˆç„¡ç†ã—ãªã„ï¼‰";
  }

  // è¡¨ç¤ºæ•´å½¢ï¼š 1ä½ â˜…â˜…â˜…ã€å¼·ã€‘ 1234
  function formatRanked(ranked){
    if(!ranked || ranked.length === 0) return "";
    const best = ranked[0].sc;
    return ranked.map((r,i)=>{
      const t = tierLabel(r.sc, best);
      return `${i+1}ä½  ${t.badge}ã€${t.label}ã€‘  ${r.n}`;
    }).join("\n");
  }
// ãƒ’ãƒ³ãƒˆæ–‡å­—åˆ—ã‹ã‚‰ã€Œå¿…ãš2ã¤ã€ã ã‘å¼·ã„æ•°å­—ã‚’é¸ã¶
function pick2FromHint(str, s, prev, prev2){
  const digits = (str || "").match(/\d/g) || [];
  const uniq = [...new Set(digits)].map(Number);

  // 2ã¤ä»¥ä¸‹ãªã‚‰ãã®ã¾ã¾
  if (uniq.length <= 2) return uniq;

  // å‰å›ãƒ»å‰ã€…å›ã‹ã‚‰ã®å¼•ã£å¼µã‚Š
  const pull = new Set(
    ((prev || "") + (prev2 || "")).match(/\d/g)?.map(Number) || []
  );

  const score = (d) => {
    let sc = 0;

    // å‡ºç¾é »åº¦ï¼ˆç›´è¿‘10ãƒ»å‰å›ãƒ»å‰ã€…å›ï¼‰
    sc += (s?.[d] ?? 0) * 10;

    // è£æ•°å­—è£œæ­£
    if (ura[d] !== undefined) sc += 2;

    // å¼•ã£å¼µã‚Š
    if (pull.has(d)) sc += 30;

    // è¶³ã™9
    if (uniq.some(x => x !== d && x + d === 9)) sc += 15;

    // é€£ç•ª
    if (uniq.some(x => x !== d && Math.abs(x - d) === 1)) sc += 8;

    return sc;
  };

  return uniq.sort((a,b)=>score(b)-score(a)).slice(0,2);
}
  // ===== ç”Ÿæˆæœ¬ä½“ï¼ˆå®‰å®šç‰ˆï¼šåŒã˜å…¥åŠ›â†’åŒã˜çµæœï¼‰=====
  function generate(){
    const s = scoreDigits();
const prevStr  = document.getElementById("prev").value;
const prev2Str = document.getElementById("prev2").value;

const hint1 = pick2FromHint(
  document.getElementById("hint1").value,
  s,
  prevStr,
  prev2Str
);

const hint2 = pick2FromHint(
  document.getElementById("hint2").value,
  s,
  prevStr,
  prev2Str
);
    const s = scoreDigits();
    const axis = chooseAxis(hint1, hint2, s);
    const pool = buildPool(hint1, hint2, s);

    // å…¥åŠ›å…¨éƒ¨ã‹ã‚‰ã‚·ãƒ¼ãƒ‰ä½œã£ã¦ã€ä¹±æ•°ã‚’å›ºå®šåŒ–
    const seedStr =
      document.getElementById("hint1").value + "|" +
      document.getElementById("hint2").value + "|" +
      document.getElementById("prev").value  + "|" +
      document.getElementById("prev2").value + "|" +
      document.getElementById("recent").value;

    const rand = mulberry32(hash32(seedStr));

    // å€™è£œã‚’ä½œã‚‹ï¼ˆ100æœ¬ï¼‰â€»åŒã˜å…¥åŠ›ãªã‚‰å¿…ãšåŒã˜100æœ¬
    let list = [];
    while(list.length < 100){
      let n = [axis[0], axis[1]];
      while(n.length < 4) n.push(pick(pool, rand));
      list.push(n.join(""));
    }

    // ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–â†’ãƒ©ãƒ³ã‚¯ä»˜ã‘
    const ranked = rank(uniq(list));

    // â˜…ã€Œå‹è² æ•°ã‚’çµã‚‹ã€ï¼š1ä½ã‚¹ã‚³ã‚¢ã®92%ä»¥ä¸Šã ã‘æ®‹ã™ï¼ˆæœ€å¤§10å£ï¼‰
    let top = [];
    if(ranked.length > 0){
      const best = ranked[0].sc;
      const threshold = best * 0.92;
      top = ranked.filter(r => r.sc >= threshold);
      if(top.length > 10) top = top.slice(0,10);
    }

    // æ—¥ã®å¼·ã•è¡¨ç¤º
    document.getElementById("dayPower").textContent =
      (top.length ? judgeDayPower(top.length) : "â€”");

    // ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆè¡¨ç¤º
    document.getElementById("straight").textContent = formatRanked(top);

    // ã‚»ãƒƒãƒˆè¡¨ç¤ºï¼ˆåŒã˜ä¸¦ã³æ›¿ãˆï¼ã‚½ãƒ¼ãƒˆã—ãŸ4æ¡ã‚’ã‚»ãƒƒãƒˆæ‰±ã„ã«ã—ã¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰
    const setNums = uniq(top.map(r => r.n.split("").sort().join("")));
    const setRanked = rank(setNums);
    // setRanked ã® best ã«åˆã‚ã›ã¦ãƒ©ãƒ™ãƒ«ä»˜ã‘ã—ãŸã„ã®ã§ formatRanked ã‚’æµç”¨
    document.getElementById("set").textContent = formatRanked(setRanked.slice(0,10));
  }
</script>

</body>
</html>
